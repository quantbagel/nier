{{- if .Values.kafkaTopics.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "nier.fullname" . }}-kafka-topics
  namespace: {{ .Values.namespace.name | default "nier" }}
  labels:
    {{- include "nier.labels" . | nindent 4 }}
    app.kubernetes.io/component: kafka-configuration
  annotations:
    helm.sh/chart: {{ include "nier.chart" . }}
    # This ConfigMap can be used by Kafka topic operators or initialization scripts
    nier.io/kafka-topics: "true"
data:
  # Topic configuration in JSON format for programmatic consumption
  topics.json: |
    {
      "topics": [
        {{- $topics := .Values.kafkaTopics.topics }}
        {{- range $index, $topic := $topics }}
        {
          "name": {{ $topic.name | quote }},
          "partitions": {{ $topic.partitions }},
          "replicationFactor": {{ $topic.replicationFactor }},
          "config": {
            "retention.ms": {{ $topic.retentionMs | quote }}
          }
        }{{- if lt (add $index 1) (len $topics) }},{{- end }}
        {{- end }}
      ]
    }

  # Topic list in YAML format for human readability
  topics.yaml: |
    # Nier Platform Kafka Topics
    # Generated by Helm chart {{ include "nier.chart" . }}
    #
    # These topics are required for the Nier platform to function correctly.
    # Use this configuration with your Kafka topic provisioning tool.

    topics:
    {{- range .Values.kafkaTopics.topics }}
      - name: {{ .name }}
        partitions: {{ .partitions }}
        replicationFactor: {{ .replicationFactor }}
        config:
          retention.ms: {{ .retentionMs }}
          {{- if eq .name "nier.ingest.frames" }}
          # High-throughput topic for video frames
          segment.bytes: "1073741824"  # 1GB segments
          compression.type: "lz4"
          {{- end }}
          {{- if eq .name "nier.dlq" }}
          # Dead letter queue - longer retention for debugging
          cleanup.policy: "delete"
          {{- end }}
    {{- end }}

  # Shell script for creating topics using kafka-topics.sh
  create-topics.sh: |
    #!/bin/bash
    # Nier Platform Kafka Topic Creation Script
    # Generated by Helm chart {{ include "nier.chart" . }}
    #
    # Usage: ./create-topics.sh <bootstrap-servers>
    # Example: ./create-topics.sh kafka-broker-1:9092,kafka-broker-2:9092

    set -euo pipefail

    BOOTSTRAP_SERVERS="${1:-{{ .Values.global.kafka.brokers }}}"
    KAFKA_BIN="${KAFKA_BIN:-/opt/kafka/bin}"

    echo "Creating Nier Platform Kafka topics..."
    echo "Bootstrap servers: ${BOOTSTRAP_SERVERS}"

    {{- range .Values.kafkaTopics.topics }}

    echo "Creating topic: {{ .name }}"
    ${KAFKA_BIN}/kafka-topics.sh \
      --bootstrap-server "${BOOTSTRAP_SERVERS}" \
      --create \
      --if-not-exists \
      --topic {{ .name }} \
      --partitions {{ .partitions }} \
      --replication-factor {{ .replicationFactor }} \
      --config retention.ms={{ .retentionMs }}
    {{- end }}

    echo "All topics created successfully!"

  # Topic documentation
  README.md: |
    # Nier Platform Kafka Topics

    This ConfigMap contains the Kafka topic configurations required by the Nier platform.

    ## Topics Overview

    | Topic | Partitions | Replication | Retention | Description |
    |-------|------------|-------------|-----------|-------------|
    {{- range .Values.kafkaTopics.topics }}
    | `{{ .name }}` | {{ .partitions }} | {{ .replicationFactor }} | {{ div .retentionMs 86400000 }}d | {{ if eq .name "nier.ingest.frames" }}Raw video frames from camera glasses{{ else if eq .name "nier.inference.results" }}ML inference results{{ else if eq .name "nier.pipeline.events" }}Processed analytics events{{ else if eq .name "nier.pipeline.activities" }}Activity recognition events{{ else if eq .name "nier.alerts" }}Alerts and notifications{{ else if eq .name "nier.dlq" }}Dead letter queue{{ else }}Platform topic{{ end }} |
    {{- end }}

    ## Usage

    ### Using the Shell Script
    ```bash
    kubectl get configmap {{ include "nier.fullname" . }}-kafka-topics -n {{ .Values.namespace.name }} -o jsonpath='{.data.create-topics\.sh}' | bash -s -- <bootstrap-servers>
    ```

    ### Using the JSON Configuration
    ```bash
    kubectl get configmap {{ include "nier.fullname" . }}-kafka-topics -n {{ .Values.namespace.name }} -o jsonpath='{.data.topics\.json}' | jq .
    ```
{{- end }}
